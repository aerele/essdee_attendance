{"version":3,"file":"Form-BDiWEqht.js","sources":["../../../../frontend/src/views/leave/Form.vue"],"sourcesContent":["<template>\n\t<ion-page>\n\t\t<ion-content :fullscreen=\"true\">\n\t\t\t<FormView\n\t\t\t\tv-if=\"formFields.data\"\n\t\t\t\tdoctype=\"Leave Application\"\n\t\t\t\tv-model=\"leaveApplication\"\n\t\t\t\t:isSubmittable=\"true\"\n\t\t\t\t:fields=\"formFields.data\"\n\t\t\t\t:id=\"props.id\"\n\t\t\t\t:showAttachmentView=\"true\"\n\t\t\t\t@validateForm=\"validateForm\"\n\t\t\t/>\n\t\t</ion-content>\n\t</ion-page>\n</template>\n\n<script setup>\nimport { IonPage, IonContent } from \"@ionic/vue\"\nimport { createResource } from \"frappe-ui\"\nimport { ref, watch, inject } from \"vue\"\n\nimport FormView from \"@/components/FormView.vue\"\n\nconst dayjs = inject(\"$dayjs\")\nconst employee = inject(\"$employee\")\nconst today = dayjs().format(\"YYYY-MM-DD\")\n\nconst props = defineProps({\n\tid: {\n\t\ttype: String,\n\t\trequired: false,\n\t},\n})\n\n// reactive object to store form data\nconst leaveApplication = ref({})\n\n// get form fields\nconst formFields = createResource({\n\turl: \"essdee_attendance.api.get_doctype_fields\",\n\tparams: { doctype: \"Leave Application\" },\n\ttransform(data) {\n\t\tlet fields = getFilteredFields(data)\n\n\t\treturn fields.map((field) => {\n\t\t\tif (field.fieldname === \"half_day_date\") field.hidden = true\n\n\t\t\tif (field.fieldname === \"posting_date\") field.default = today\n\n\t\t\treturn field\n\t\t})\n\t},\n\tonSuccess(_data) {\n\t\tleaveApprovalDetails.reload()\n\t\tleaveTypes.reload()\n\t},\n})\nformFields.reload()\n\nconst leaveApprovalDetails = createResource({\n\turl: \"essdee_attendance.api.get_leave_approval_details\",\n\tparams: { employee: employee.data.name },\n\tonSuccess(data) {\n\t\tsetLeaveApprovers(data)\n\t},\n})\n\nconst leaveTypes = createResource({\n\turl: \"essdee_attendance.api.get_leave_types\",\n\tparams: {\n\t\temployee: employee.data.name,\n\t\tdate: today,\n\t},\n\tonSuccess(data) {\n\t\tsetLeaveTypes(data)\n\t},\n})\n\n// form scripts\nwatch(\n\t() => leaveApplication.value.employee,\n\t(employee_id) => {\n\t\tif (props.id && employee_id !== employee.data.name) {\n\t\t\t// if employee is not the current user, set form as read only\n\t\t\tsetFormReadOnly()\n\t\t}\n\t}\n)\nwatch(\n\t() => leaveApplication.value.leave_type,\n\t(leave_type) => setLeaveBalance(leave_type)\n)\n\nwatch(\n\t() => leaveApplication.value.half_day,\n\t(half_day) => setHalfDayDate(half_day)\n)\n\nwatch(\n\t() => leaveApplication.value.half_day && leaveApplication.value.half_day_date,\n\t() => setTotalLeaveDays()\n)\n\nwatch(\n\t() => leaveApplication.value.from_date,\n\t(from_date) => {\n\t\tif (!leaveApplication.value.to_date) {\n\t\t\tleaveApplication.value.to_date = from_date\n\t\t}\n\n\t\t// fetch leave types for the selected date\n\t\tleaveTypes.fetch({\n\t\t\temployee: employee.data.name,\n\t\t\tdate: from_date,\n\t\t})\n\t}\n)\n\nwatch(\n\t() => [leaveApplication.value.from_date, leaveApplication.value.to_date],\n\t([from_date, to_date]) => {\n\t\tvalidateDates(from_date, to_date)\n\t\tsetHalfDayDateRange()\n\t\tsetTotalLeaveDays()\n\t}\n)\n\n// helper functions\nfunction getFilteredFields(fields) {\n\t// reduce noise from the form view by excluding unnecessary fields\n\t// ex: employee and other details can be fetched from the session user\n\tconst excludeFields = [\n\t\t\"naming_series\",\n\t\t\"sb_other_details\",\n\t\t\"salary_slip\",\n\t\t\"letter_head\",\n\t]\n\n\tconst employeeFields = [\n\t\t\"employee\",\n\t\t\"employee_name\",\n\t\t\"department\",\n\t\t\"company\",\n\t\t\"follow_via_email\",\n\t\t\"status\",\n\t\t\"posting_date\",\n\t]\n\n\tif (!props.id) excludeFields.push(...employeeFields)\n\n\treturn fields.filter((field) => !excludeFields.includes(field.fieldname))\n}\n\nfunction setFormReadOnly() {\n\tif (leaveApplication.value.leave_approver === employee.data.user_id) return\n\tformFields.data.map((field) => (field.read_only = true))\n}\n\nfunction validateDates(from_date, to_date) {\n\tif (!(from_date && to_date)) return\n\n\tconst error_message =\n\t\tfrom_date > to_date ? \"To Date cannot be before From Date\" : \"\"\n\n\tconst from_date_field = formFields.data.find(\n\t\t(field) => field.fieldname === \"from_date\"\n\t)\n\tfrom_date_field.error_message = error_message\n}\n\nfunction setTotalLeaveDays() {\n\tif (!areValuesSet()) return\n\n\tconst leaveDays = createResource({\n\t\turl: \"hrms.hr.doctype.leave_application.leave_application.get_number_of_leave_days\",\n\t\tparams: {\n\t\t\temployee: employee.data.name,\n\t\t\tleave_type: leaveApplication.value.leave_type,\n\t\t\tfrom_date: leaveApplication.value.from_date,\n\t\t\tto_date: leaveApplication.value.to_date,\n\t\t\thalf_day: leaveApplication.value.half_day,\n\t\t\thalf_day_date: leaveApplication.value.half_day_date,\n\t\t},\n\t\tonSuccess(data) {\n\t\t\tleaveApplication.value.total_leave_days = data\n\t\t},\n\t})\n\tleaveDays.reload()\n\tsetLeaveBalance()\n}\n\nfunction setLeaveBalance() {\n\tif (!areValuesSet()) return\n\n\tconst leaveBalance = createResource({\n\t\turl: \"hrms.hr.doctype.leave_application.leave_application.get_leave_balance_on\",\n\t\tparams: {\n\t\t\temployee: employee.data.name,\n\t\t\tdate: leaveApplication.value.from_date,\n\t\t\tto_date: leaveApplication.value.to_date,\n\t\t\tleave_type: leaveApplication.value.leave_type,\n\t\t\tconsider_all_leaves_in_the_allocation_period: 1,\n\t\t},\n\t\tonSuccess(data) {\n\t\t\tleaveApplication.value.leave_balance = data\n\t\t},\n\t})\n\tleaveBalance.reload()\n}\n\nfunction setHalfDayDate(half_day) {\n\tconst half_day_date = formFields.data.find(\n\t\t(field) => field.fieldname === \"half_day_date\"\n\t)\n\thalf_day_date.hidden = !half_day\n\thalf_day_date.reqd = half_day\n\n\tif (!half_day) return\n\n\tif (leaveApplication.value.from_date === leaveApplication.value.to_date) {\n\t\tleaveApplication.value.half_day_date = leaveApplication.value.from_date\n\t} else {\n\t\tsetHalfDayDateRange()\n\t}\n}\n\nfunction setHalfDayDateRange() {\n\tconst half_day_date = formFields.data.find(\n\t\t(field) => field.fieldname === \"half_day_date\"\n\t)\n\thalf_day_date.minDate = leaveApplication.value.from_date\n\thalf_day_date.maxDate = leaveApplication.value.to_date\n}\n\nfunction setLeaveApprovers(data) {\n\tconst leave_approver = formFields.data?.find(\n\t\t(field) => field.fieldname === \"leave_approver\"\n\t)\n\tleave_approver.reqd = data?.is_mandatory\n\tleave_approver.documentList = data?.department_approvers.map((approver) => ({\n\t\tlabel: approver.full_name\n\t\t\t? `${approver.name} : ${approver.full_name}`\n\t\t\t: approver.name,\n\t\tvalue: approver.name,\n\t}))\n\n\tleaveApplication.value.leave_approver = data?.leave_approver\n\tleaveApplication.value.leave_approver_name = data?.leave_approver_name\n}\n\nfunction setLeaveTypes(data) {\n\tconst leave_type = formFields.data.find(\n\t\t(field) => field.fieldname === \"leave_type\"\n\t)\n\tleave_type.documentList = data?.map((leave_type) => ({\n\t\tlabel: leave_type,\n\t\tvalue: leave_type,\n\t}))\n}\n\nfunction areValuesSet() {\n\treturn (\n\t\tleaveApplication.value.from_date &&\n\t\tleaveApplication.value.to_date &&\n\t\tleaveApplication.value.leave_type\n\t)\n}\n\nfunction validateForm() {\n\tsetHalfDayDate(leaveApplication.value.half_day)\n\tleaveApplication.value.employee = employee.data.name\n}\n</script>\n"],"names":["dayjs","inject","employee","today","props","__props","leaveApplication","ref","formFields","createResource","data","getFilteredFields","field","_data","leaveApprovalDetails","leaveTypes","setLeaveApprovers","setLeaveTypes","watch","employee_id","setFormReadOnly","leave_type","setLeaveBalance","half_day","setHalfDayDate","setTotalLeaveDays","from_date","to_date","validateDates","setHalfDayDateRange","fields","excludeFields","employeeFields","error_message","from_date_field","areValuesSet","half_day_date","leave_approver","_a","approver","validateForm"],"mappings":"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"}