{"version":3,"file":"Detail-CDHfX5zT.js","sources":["../../../../frontend/src/views/salary_slip/Detail.vue"],"sourcesContent":["<template>\n\t<ion-page>\n\t\t<ion-content :fullscreen=\"true\">\n\t\t\t<FormView\n\t\t\t\tv-if=\"formFields.data\"\n\t\t\t\tdoctype=\"Salary Slip\"\n\t\t\t\tv-model=\"salarySlip\"\n\t\t\t\t:fields=\"formFields.data\"\n\t\t\t\t:id=\"props.id\"\n\t\t\t\t:tabbedView=\"true\"\n\t\t\t\t:tabs=\"tabs\"\n\t\t\t\t:showFormButton=\"false\"\n\t\t\t>\n\t\t\t\t<!-- Child Tables -->\n\t\t\t\t<template #earnings=\"{ isFormReadOnly }\">\n\t\t\t\t\t<SalaryDetailTable\n\t\t\t\t\t\ttype=\"Earnings\"\n\t\t\t\t\t\t:salarySlip=\"salarySlip\"\n\t\t\t\t\t\t:isReadOnly=\"isFormReadOnly\"\n\t\t\t\t\t/>\n\t\t\t\t</template>\n\n\t\t\t\t<template #deductions=\"{ isFormReadOnly }\">\n\t\t\t\t\t<SalaryDetailTable\n\t\t\t\t\t\ttype=\"Deductions\"\n\t\t\t\t\t\t:salarySlip=\"salarySlip\"\n\t\t\t\t\t\t:isReadOnly=\"isFormReadOnly\"\n\t\t\t\t\t/>\n\t\t\t\t</template>\n\n\t\t\t\t<template #formButton>\n\t\t\t\t\t<ErrorMessage :message=\"downloadError\" class=\"mt-2\" />\n\t\t\t\t\t<Button\n\t\t\t\t\t\tclass=\"w-full rounded py-5 text-base disabled:bg-gray-700 disabled:text-white\"\n\t\t\t\t\t\t@click=\"downloadPDF\"\n\t\t\t\t\t\tvariant=\"solid\"\n\t\t\t\t\t\t:loading=\"loading\"\n\t\t\t\t\t>\n\t\t\t\t\t\tDownload PDF\n\t\t\t\t\t</Button>\n\t\t\t\t</template>\n\t\t\t</FormView>\n\t\t</ion-content>\n\t</ion-page>\n</template>\n\n<script setup>\nimport { ref, watch } from \"vue\"\nimport { IonPage, IonContent } from \"@ionic/vue\"\n\nimport { createResource, ErrorMessage } from \"frappe-ui\"\n\nimport FormView from \"@/components/FormView.vue\"\nimport SalaryDetailTable from \"@/components/SalaryDetailTable.vue\"\n\nimport { getCompanyCurrency } from \"@/data/currencies\"\n\nconst props = defineProps({\n\tid: {\n\t\ttype: String,\n\t\trequired: true,\n\t},\n})\n\nconst downloadError = ref(\"\")\nconst loading = ref(false)\n\n// reactive object to store form data\nconst salarySlip = ref({})\n\n// get form fields\nconst formFields = createResource({\n\turl: \"essdee_attendance.api.get_doctype_fields\",\n\tparams: { doctype: \"Salary Slip\" },\n\ttransform(data) {\n\t\treturn getFilteredFields(data)\n\t},\n})\nformFields.reload()\n\nconst tabs = [\n\t{ name: \"Details\", lastField: \"payment_days\" },\n\t{ name: \"Earnings & Deductions\", lastField: \"base_total_deduction\" },\n\t{ name: \"Net Pay Info\", lastField: \"base_total_in_words\" },\n\t{ name: \"Income Tax Breakup\", lastField: \"total_income_tax\" },\n\t{ name: \"Bank Details\", lastField: \"bank_account_no\" },\n]\n\nwatch(\n\t() => salarySlip.value.company,\n\tasync (company) => {\n\t\tif (!company) return\n\n\t\tconst companyCurrency = await getCompanyCurrency(company)\n\n\t\tformFields.data?.map((field) => {\n\t\t\tif (field.label?.includes(\"Company Currency\")) {\n\t\t\t\tif (salarySlip.value.currency === companyCurrency) {\n\t\t\t\t\t// hide base currency fields\n\t\t\t\t\tfield.hidden = true\n\t\t\t\t} else {\n\t\t\t\t\t// set currency in label\n\t\t\t\t\tfield.label = field.label.replace(\"Company Currency\", companyCurrency)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t},\n\t{ immediate: true }\n)\n\nfunction getFilteredFields(fields) {\n\tconst hasTimesheets = salarySlip.value?.timesheets?.length\n\tif (hasTimesheets) return fields\n\n\tconst excludeFields = [\n\t\t\"timesheets_section\",\n\t\t\"timesheets\",\n\t\t\"total_working_hours\",\n\t\t\"hour_rate\",\n\t\t\"base_hour_rate\",\n\t\t\"help_section\",\n\t\t\"earning_deduction_sb\",\n\t]\n\treturn fields.filter((field) => !excludeFields.includes(field.fieldname))\n}\n\nfunction downloadPDF() {\n\tconst salarySlipName = salarySlip.value.name\n\tloading.value = true\n\n\tlet headers = { \"X-Frappe-Site-Name\": window.location.hostname }\n\tif (window.csrf_token) {\n\t\theaders[\"X-Frappe-CSRF-Token\"] = window.csrf_token\n\t}\n\n\tfetch(\"/api/method/essdee_attendance.api.download_salary_slip\", {\n\t\tmethod: \"POST\",\n\t\theaders,\n\t\tbody: new URLSearchParams({ name: salarySlipName }),\n\t\tresponseType: \"blob\",\n\t})\n\t\t.then((response) => {\n\t\t\tif (response.ok) {\n\t\t\t\treturn response.blob()\n\t\t\t} else {\n\t\t\t\tdownloadError.value = \"Failed to download PDF\"\n\t\t\t}\n\t\t})\n\t\t.then((blob) => {\n\t\t\tif (!blob) return\n\t\t\tconst blobUrl = window.URL.createObjectURL(blob)\n\t\t\tconst link = document.createElement(\"a\")\n\t\t\tlink.href = blobUrl\n\t\t\tlink.download = `${salarySlipName}.pdf`\n\t\t\tlink.click()\n\n\t\t\tsetTimeout(() => {\n\t\t\t\twindow.URL.revokeObjectURL(blobUrl)\n\t\t\t}, 3000)\n\t\t})\n\t\t.catch((error) => {\n\t\t\tdownloadError.value = `Failed to download PDF: ${error.message}`\n\t\t})\n\t\t.finally(() => {\n\t\t\tloading.value = false\n\t\t})\n}\n</script>\n"],"names":["props","__props","downloadError","ref","loading","salarySlip","formFields","createResource","data","getFilteredFields","tabs","watch","company","__async","companyCurrency","getCompanyCurrency","_a","field","fields","_b","excludeFields","downloadPDF","salarySlipName","headers","response","blob","blobUrl","link","error"],"mappings":"4wBAyDA,MAAMA,EAAQC,EAORC,EAAgBC,EAAI,EAAE,EACtBC,EAAUD,EAAI,EAAK,EAGnBE,EAAaF,EAAI,EAAE,EAGnBG,EAAaC,EAAe,CACjC,IAAK,2CACL,OAAQ,CAAE,QAAS,aAAe,EAClC,UAAUC,EAAM,CACf,OAAOC,EAAkBD,CAAI,CAC7B,CACF,CAAC,EACDF,EAAW,OAAQ,EAEnB,MAAMI,EAAO,CACZ,CAAE,KAAM,UAAW,UAAW,cAAgB,EAC9C,CAAE,KAAM,wBAAyB,UAAW,sBAAwB,EACpE,CAAE,KAAM,eAAgB,UAAW,qBAAuB,EAC1D,CAAE,KAAM,qBAAsB,UAAW,kBAAoB,EAC7D,CAAE,KAAM,eAAgB,UAAW,iBAAmB,CACvD,EAEAC,EACC,IAAMN,EAAW,MAAM,QAChBO,GAAYC,EAAA,4BAClB,GAAI,CAACD,EAAS,OAEd,MAAME,EAAkB,MAAMC,EAAmBH,CAAO,GAExDI,EAAAV,EAAW,OAAX,MAAAU,EAAiB,IAAKC,GAAU,QAC3BD,EAAAC,EAAM,QAAN,MAAAD,EAAa,SAAS,sBACrBX,EAAW,MAAM,WAAaS,EAEjCG,EAAM,OAAS,GAGfA,EAAM,MAAQA,EAAM,MAAM,QAAQ,mBAAoBH,CAAe,EAG1E,EACE,GACD,CAAE,UAAW,EAAM,CACpB,EAEA,SAASL,EAAkBS,EAAQ,SAElC,IADsBC,GAAAH,EAAAX,EAAW,QAAX,YAAAW,EAAkB,aAAlB,YAAAG,EAA8B,OACjC,OAAOD,EAE1B,MAAME,EAAgB,CACrB,qBACA,aACA,sBACA,YACA,iBACA,eACA,sBACA,EACD,OAAOF,EAAO,OAAQD,GAAU,CAACG,EAAc,SAASH,EAAM,SAAS,CAAC,CACzE,CAEA,SAASI,GAAc,CACtB,MAAMC,EAAiBjB,EAAW,MAAM,KACxCD,EAAQ,MAAQ,GAEhB,IAAImB,EAAU,CAAE,qBAAsB,OAAO,SAAS,QAAU,EAC5D,OAAO,aACVA,EAAQ,qBAAqB,EAAI,OAAO,YAGzC,MAAM,yDAA0D,CAC/D,OAAQ,OACR,QAAAA,EACA,KAAM,IAAI,gBAAgB,CAAE,KAAMD,CAAc,CAAE,EAClD,aAAc,MAChB,CAAE,EACC,KAAME,GAAa,CACnB,GAAIA,EAAS,GACZ,OAAOA,EAAS,KAAM,EAEtBtB,EAAc,MAAQ,wBAE1B,CAAG,EACA,KAAMuB,GAAS,CACf,GAAI,CAACA,EAAM,OACX,MAAMC,EAAU,OAAO,IAAI,gBAAgBD,CAAI,EACzCE,EAAO,SAAS,cAAc,GAAG,EACvCA,EAAK,KAAOD,EACZC,EAAK,SAAW,GAAGL,CAAc,OACjCK,EAAK,MAAO,EAEZ,WAAW,IAAM,CAChB,OAAO,IAAI,gBAAgBD,CAAO,CAClC,EAAE,GAAI,CACV,CAAG,EACA,MAAOE,GAAU,CACjB1B,EAAc,MAAQ,2BAA2B0B,EAAM,OAAO,EACjE,CAAG,EACA,QAAQ,IAAM,CACdxB,EAAQ,MAAQ,EACnB,CAAG,CACH"}