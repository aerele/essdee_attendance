{"version":3,"file":"workflow-CgWnsJgA.js","sources":["../../../../frontend/src/composables/workflow.js"],"sourcesContent":["import { createResource, toast } from \"frappe-ui\"\nimport { computed } from \"vue\"\nimport { userResource } from \"@/data/user\"\n\nexport default function useWorkflow(doctype) {\n\tconst workflowDoc = createResource({\n\t\turl: \"essdee_attendance.api.get_workflow\",\n\t\tparams: { doctype: doctype },\n\t\tcache: [\"hrms:workflow\", doctype],\n\t})\n\tworkflowDoc.reload()\n\n\tconst hasWorkflow = computed(() => {\n\t\tconst workflowData = workflowDoc?.data\n\t\treturn Boolean(Object.keys(workflowData || {}).length > 0)\n\t})\n\n\tconst getWorkflowStateField = () => {\n\t\t// NOTE: checkbox labelled 'Don't Override Status' is named override_status hence the inverted logic\n\t\treturn !workflowDoc.data?.override_status\n\t\t\t? workflowDoc.data?.workflow_state_field\n\t\t\t: \"\"\n\t}\n\n\tconst getDefaultState = (docstatus) => {\n\t\treturn workflowDoc.data?.states.find(\n\t\t\t(state) => state.doc_status == docstatus\n\t\t)\n\t}\n\n\tconst getTransitions = async (doc) => {\n\t\tconst transitions = createResource({\n\t\t\turl: \"frappe.model.workflow.get_transitions\",\n\t\t\tparams: { doc: doc },\n\t\t\ttransform: (data) => {\n\t\t\t\tconst isSelfApproval = userResource?.data?.name == doc.owner\n\n\t\t\t\treturn data\n\t\t\t\t\t.filter(\n\t\t\t\t\t\t(transition) => transition.allow_self_approval || !isSelfApproval\n\t\t\t\t\t)\n\t\t\t\t\t.map((transition) => transition.action)\n\t\t\t},\n\t\t})\n\n\t\treturn await transitions.reload()\n\t}\n\n\tconst getDocumentStateRoles = (state) => {\n\t\treturn workflowDoc.data?.states\n\t\t\t.filter((s) => s.state == state)\n\t\t\t.map((s) => s.allow_edit)\n\t}\n\n\tconst isReadOnly = (doc) => {\n\t\tconst state_fieldname = workflowDoc.data?.workflow_state_field\n\t\tif (!state_fieldname) return false\n\n\t\tconst state = doc[state_fieldname] || getDefaultState(doc.docstatus)\n\n\t\tconst roles = getDocumentStateRoles(state)\n\t\treturn !roles.some((role) => userResource.data.roles.includes(role))\n\t}\n\n\tconst applyWorkflow = async (doc, action) => {\n\t\tconst applyWorkflow = createResource({\n\t\t\turl: \"frappe.model.workflow.apply_workflow\",\n\t\t\tparams: { doc: doc, action: action },\n\t\t\tonSuccess() {\n\t\t\t\ttoast({\n\t\t\t\t\ttitle: \"Success\",\n\t\t\t\t\ttext: `Workflow action '${action}' applied successfully`,\n\t\t\t\t\ticon: \"check-circle\",\n\t\t\t\t\tposition: \"bottom-center\",\n\t\t\t\t\ticonClasses: \"text-green-500\",\n\t\t\t\t})\n\t\t\t},\n\t\t\tonError() {\n\t\t\t\ttoast({\n\t\t\t\t\ttitle: \"Error\",\n\t\t\t\t\ttext: `Error applying workflow action: ${action}`,\n\t\t\t\t\ticon: \"alert-circle\",\n\t\t\t\t\tposition: \"bottom-center\",\n\t\t\t\t\ticonClasses: \"text-red-500\",\n\t\t\t\t})\n\t\t\t\tconsole.log(`Error applying workflow action: ${action}`)\n\t\t\t},\n\t\t})\n\t\tawait applyWorkflow.reload()\n\t}\n\n\treturn {\n\t\thasWorkflow,\n\t\tworkflowDoc,\n\t\tgetWorkflowStateField,\n\t\tgetTransitions,\n\t\tgetDocumentStateRoles,\n\t\tisReadOnly,\n\t\tapplyWorkflow,\n\t}\n}\n"],"names":["useWorkflow","doctype","workflowDoc","createResource","hasWorkflow","computed","workflowData","getWorkflowStateField","_a","_b","getDefaultState","docstatus","state","getTransitions","doc","__async","data","isSelfApproval","userResource","transition","getDocumentStateRoles","s","state_fieldname","role","action","toast"],"mappings":"gTAIe,SAASA,EAAYC,EAAS,CAC5C,MAAMC,EAAcC,EAAe,CAClC,IAAK,qCACL,OAAQ,CAAE,QAASF,CAAS,EAC5B,MAAO,CAAC,gBAAiBA,CAAO,CAClC,CAAE,EACDC,EAAY,OAAQ,EAEpB,MAAME,EAAcC,EAAS,IAAM,CAClC,MAAMC,EAAeJ,GAAA,YAAAA,EAAa,KAClC,OAAe,OAAO,KAAKI,GAAgB,EAAE,EAAE,OAAS,CAC1D,CAAE,EAEKC,EAAwB,IAAM,SAEnC,OAAQC,EAAAN,EAAY,OAAZ,MAAAM,EAAkB,gBAEvB,IADAC,EAAAP,EAAY,OAAZ,YAAAO,EAAkB,oBAErB,EAEKC,EAAmBC,GAAc,OACtC,OAAOH,EAAAN,EAAY,OAAZ,YAAAM,EAAkB,OAAO,KAC9BI,GAAUA,EAAM,YAAcD,EAEhC,EAEKE,EAAwBC,GAAQC,EAAA,sBAerC,OAAO,MAdaZ,EAAe,CAClC,IAAK,wCACL,OAAQ,CAAE,IAAKW,CAAK,EACpB,UAAYE,GAAS,SACpB,MAAMC,IAAiBR,GAAAD,EAAAU,IAAA,YAAAV,EAAc,OAAd,YAAAC,EAAoB,OAAQK,EAAI,MAEvD,OAAOE,EACL,OACCG,GAAeA,EAAW,qBAAuB,CAACF,CACnD,EACA,IAAKE,GAAeA,EAAW,MAAM,CACvC,CACJ,CAAG,EAEwB,OAAQ,CACjC,GAEKC,EAAyBR,GAAU,OACxC,OAAOJ,EAAAN,EAAY,OAAZ,YAAAM,EAAkB,OACvB,OAAQa,GAAMA,EAAE,OAAST,GACzB,IAAKS,GAAMA,EAAE,WACf,EAuCD,MAAO,CACN,YAAAjB,EACA,YAAAF,EACA,sBAAAK,EACA,eAAAM,EACA,sBAAAO,EACA,WA3CmBN,GAAQ,OAC3B,MAAMQ,GAAkBd,EAAAN,EAAY,OAAZ,YAAAM,EAAkB,qBAC1C,GAAI,CAACc,EAAiB,MAAO,GAE7B,MAAMV,EAAQE,EAAIQ,CAAe,GAAKZ,EAAgBI,EAAI,SAAS,EAGnE,MAAO,CADOM,EAAsBR,CAAK,EAC3B,KAAMW,GAASL,EAAa,KAAK,MAAM,SAASK,CAAI,CAAC,CACnE,EAoCA,cAlCqB,CAAOT,EAAKU,IAAWT,EAAA,sBAwB5C,MAvBsBZ,EAAe,CACpC,IAAK,uCACL,OAAQ,CAAE,IAAKW,EAAK,OAAQU,CAAQ,EACpC,WAAY,CACXC,EAAM,CACL,MAAO,UACP,KAAM,oBAAoBD,CAAM,yBAChC,KAAM,eACN,SAAU,gBACV,YAAa,gBAClB,CAAK,CACD,EACD,SAAU,CACTC,EAAM,CACL,MAAO,QACP,KAAM,mCAAmCD,CAAM,GAC/C,KAAM,eACN,SAAU,gBACV,YAAa,cAClB,CAAK,EACD,QAAQ,IAAI,mCAAmCA,CAAM,EAAE,CACvD,CACJ,CAAG,EACmB,OAAQ,CAC5B,EAUA,CACF"}